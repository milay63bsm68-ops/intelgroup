<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Group</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#17212b;--surface:#1e2c3a;--surface2:#242f3d;
  --accent:#5288c1;--accent2:#64b5f6;--text:#e8e8e8;
  --subtext:#8a9ba8;--border:#2b3a4a;--green:#4db6ac;
  --red:#ef5350;
}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;}

/* HEADER */
.header{background:var(--surface);padding:14px 16px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;}
.back-btn{background:none;border:none;color:var(--accent2);font-size:22px;cursor:pointer;line-height:1;}
.header-title{font-size:17px;font-weight:700;}

/* FORM */
.form{padding:20px 16px;max-width:480px;margin:0 auto;}
.sec-label{font-size:11px;color:var(--subtext);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;margin-top:20px;}

/* â”€â”€ AVATAR PREVIEW â”€â”€ */
.av-center{display:flex;justify-content:center;margin-bottom:4px;}
.av-preview{
  width:90px;height:90px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:36px;font-weight:700;color:white;
  border:3px solid var(--border);overflow:hidden;
  transition:border-color 0.2s;position:relative;
  background:var(--accent);
  user-select:none;
}
.av-preview img{width:100%;height:100%;object-fit:cover;}
.av-preview .av-badge{
  position:absolute;bottom:0;left:0;right:0;
  background:rgba(0,0,0,0.55);font-size:11px;
  text-align:center;padding:3px 0;color:#fff;
}

/* â”€â”€ EMOJI AVATAR PICKER â”€â”€ */
.emoji-grid{
  display:grid;grid-template-columns:repeat(6,1fr);gap:8px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:14px;padding:12px;
}
.emoji-opt{
  aspect-ratio:1;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:26px;cursor:pointer;
  border:2px solid transparent;transition:all 0.15s;
  position:relative;
}
.emoji-opt:hover{transform:scale(1.12);}
.emoji-opt.selected{border-color:var(--accent2);box-shadow:0 0 0 2px var(--accent);}

/* color row */
.color-strip{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center;}
.color-dot{
  width:30px;height:30px;border-radius:50%;cursor:pointer;
  border:2px solid transparent;transition:all 0.15s;
}
.color-dot:hover{transform:scale(1.15);}
.color-dot.selected{border-color:#fff;box-shadow:0 0 0 2px var(--accent);}

/* â”€â”€ IMAGE URL INPUT â”€â”€ */
.img-url-hint{font-size:11px;color:var(--subtext);margin-top:6px;line-height:1.5;}
.url-status{font-size:12px;margin-top:5px;min-height:16px;}
.url-status.ok{color:var(--green);}
.url-status.err{color:var(--red);}
.url-status.loading{color:#f59e0b;}

/* â”€â”€ INPUTS â”€â”€ */
.inp{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:13px 14px;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.inp:focus{border-color:var(--accent2);}
textarea.inp{resize:none;height:90px;font-family:inherit;}
.char-count{text-align:right;font-size:11px;color:var(--subtext);margin-top:4px;}

/* â”€â”€ TOGGLES â”€â”€ */
.toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:8px;}
.toggle-info{flex:1;margin-right:12px;}
.toggle-label{font-size:14px;font-weight:600;}
.toggle-sub{font-size:12px;color:var(--subtext);margin-top:2px;}
.sw{position:relative;width:44px;height:24px;flex-shrink:0;}
.sw input{opacity:0;width:0;height:0;position:absolute;}
.sw-track{position:absolute;inset:0;border-radius:12px;background:#2b3a4a;cursor:pointer;transition:background 0.2s;}
.sw input:checked~.sw-track{background:var(--accent);}
.sw-thumb{position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:50%;background:white;transition:transform 0.2s;pointer-events:none;}
.sw input:checked~.sw-track .sw-thumb{transform:translateX(20px);}

/* â”€â”€ BUTTON â”€â”€ */
.btn-create{width:100%;padding:15px;margin-top:24px;border:none;border-radius:14px;background:var(--accent);color:white;font-size:16px;font-weight:700;cursor:pointer;transition:transform 0.1s,opacity 0.2s;}
.btn-create:active{transform:scale(0.98);}
.btn-create:disabled{opacity:0.4;}

/* â”€â”€ MSG â”€â”€ */
.msg{padding:12px 14px;border-radius:12px;font-size:13px;margin-top:12px;}
.error{background:#3d1515;border:1px solid var(--red);color:#fca5a5;}
.success{background:#1a3a2a;border:1px solid var(--green);color:#86efac;}
.loading{background:#2a2a15;border:1px solid #f59e0b;color:#fcd34d;}
</style>
</head>
<body>
<div class="header">
  <button class="back-btn" onclick="history.back()">â†</button>
  <div class="header-title">New Group</div>
</div>

<div class="form">

  <!-- AVATAR PREVIEW -->
  <div class="av-center">
    <div class="av-preview" id="avPreview">
      <span id="avContent">G</span>
    </div>
  </div>

  <!-- EMOJI PICKER (always visible) -->
  <div class="sec-label" style="margin-top:14px;">Choose Avatar</div>
  <div class="emoji-grid" id="emojiGrid"></div>
  <div class="color-strip" id="colorStrip"></div>

  <!-- IMAGE URL (optional override) -->
  <div class="sec-label">Or Use Image URL (optional)</div>
  <input class="inp" id="imgUrlInput" type="url"
    placeholder="https://i.imgur.com/example.jpg"
    oninput="onUrlInput(this.value)">
  <div class="url-status" id="urlStatus"></div>
  <div class="img-url-hint">Paste any direct image link â€” it will be used as your group avatar instead of the emoji above.</div>

  <!-- GROUP NAME -->
  <div class="sec-label">Group Name *</div>
  <input class="inp" id="gName" maxlength="64" placeholder="Enter group nameâ€¦"
    oninput="onNameInput(this.value);document.getElementById('nc').textContent=this.value.length">
  <div class="char-count"><span id="nc">0</span>/64</div>

  <!-- DESCRIPTION -->
  <div class="sec-label">Description</div>
  <textarea class="inp" id="gDesc" maxlength="255" placeholder="What is this group about?"
    oninput="document.getElementById('dc').textContent=this.value.length"></textarea>
  <div class="char-count"><span id="dc">0</span>/255</div>

  <!-- SETTINGS -->
  <div class="sec-label">Settings</div>
  <div class="toggle-row">
    <div class="toggle-info">
      <div class="toggle-label">ğŸ”’ Private Group</div>
      <div class="toggle-sub">Only people with the link can join</div>
    </div>
    <label class="sw"><input type="checkbox" id="isPrivate"><div class="sw-track"><div class="sw-thumb"></div></div></label>
  </div>
  <div class="toggle-row">
    <div class="toggle-info">
      <div class="toggle-label">â­ Premium Only</div>
      <div class="toggle-sub">Only premium users can join</div>
    </div>
    <label class="sw"><input type="checkbox" id="isPremiumOnly"><div class="sw-track"><div class="sw-thumb"></div></div></label>
  </div>

  <button class="btn-create" id="createBtn" onclick="createGroup()">âœ… Create Group</button>
  <div id="msgBox"></div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TELEGRAM INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tg = window.Telegram?.WebApp;
tg?.ready();
const user       = tg?.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;
const userName   = user?.first_name || "Guest";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AVATAR STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EMOJIS = [
  "ğŸ˜€","ğŸ˜","ğŸ¤©","ğŸ¥³","ğŸ¦","ğŸ¯","ğŸ»","ğŸ¦Š","ğŸ¼","ğŸ¦„",
  "ğŸŒŸ","ğŸ”¥","ğŸ’","ğŸš€","âš¡","ğŸŒˆ","ğŸ®","ğŸ¯","ğŸ†","ğŸ’¡",
  "ğŸµ","ğŸ¸","ğŸŒº","ğŸ€","ğŸŒ™","â„ï¸","ğŸŒŠ","ğŸ­","ğŸ¦‹","ğŸ¦…"
];
const COLORS = [
  "#5288c1","#4db6ac","#ef5350","#f59e0b","#9c27b0",
  "#e91e63","#00bcd4","#8bc34a","#ff5722","#607d8b",
  "#795548","#3f51b5","#009688","#ffc107","#673ab7"
];

let selectedEmoji = "ğŸ˜€";
let selectedColor = COLORS[0];
let avatarImageUrl = null; // final hosted URL (string) or null

function buildEmojiGrid() {
  const grid = document.getElementById("emojiGrid");
  grid.innerHTML = "";
  EMOJIS.forEach((em, i) => {
    const el = document.createElement("div");
    el.className = "emoji-opt" + (i === 0 ? " selected" : "");
    el.textContent = em;
    el.style.background = COLORS[i % COLORS.length];
    el.onclick = () => {
      document.querySelectorAll(".emoji-opt").forEach(e => e.classList.remove("selected"));
      el.classList.add("selected");
      selectedEmoji = em;
      avatarImageUrl = null;
      renderPreview();
    };
    grid.appendChild(el);
  });
}

function buildColorStrip() {
  const strip = document.getElementById("colorStrip");
  strip.innerHTML = "";
  COLORS.forEach((c, i) => {
    const el = document.createElement("div");
    el.className = "color-dot" + (i === 0 ? " selected" : "");
    el.style.background = c;
    el.title = c;
    el.onclick = () => {
      document.querySelectorAll(".color-dot").forEach(d => d.classList.remove("selected"));
      el.classList.add("selected");
      selectedColor = c;
      avatarImageUrl = null;
      renderPreview();
    };
    strip.appendChild(el);
  });
}

function renderPreview() {
  const preview = document.getElementById("avPreview");
  const content = document.getElementById("avContent");
  if (avatarImageUrl) {
    preview.style.background = "transparent";
    preview.innerHTML = `<img src="${avatarImageUrl}" alt="avatar">`;
  } else {
    preview.style.background = selectedColor;
    preview.innerHTML = `<span id="avContent" style="font-size:36px">${selectedEmoji}</span>`;
  }
}

function onNameInput(val) {
  if (!avatarImageUrl) renderPreview();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE URL â€” live preview as user types
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let urlDebounce = null;
function onUrlInput(val) {
  clearTimeout(urlDebounce);
  const trimmed = val.trim();
  if (!trimmed) {
    // cleared â€” fall back to emoji
    avatarImageUrl = null;
    renderPreview();
    setUrlStatus("", "");
    return;
  }
  setUrlStatus("â³ Loadingâ€¦", "loading");
  urlDebounce = setTimeout(() => {
    const img = new Image();
    img.onload = () => {
      avatarImageUrl = trimmed;
      renderPreview();
      setUrlStatus("âœ… Image loaded!", "ok");
    };
    img.onerror = () => {
      avatarImageUrl = null;
      renderPreview();
      setUrlStatus("âŒ Could not load image from this URL", "err");
    };
    img.src = trimmed;
  }, 600);
}

function setUrlStatus(msg, cls) {
  const el = document.getElementById("urlStatus");
  el.textContent = msg;
  el.className = "url-status " + cls;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD AVATAR VALUE FOR API
   Returns a small JSON string stored on GitHub
   instead of a huge base64 blob
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildAvatarValue() {
  if (avatarImageUrl) {
    // Store as a URL reference â€” tiny string
    return JSON.stringify({ type: "url", src: avatarImageUrl });
  } else {
    // Store emoji + color â€” a few bytes only
    return JSON.stringify({ type: "emoji", emoji: selectedEmoji, color: selectedColor });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CREATE GROUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function createGroup() {
  const gName = document.getElementById("gName").value.trim();
  if (!telegramId) return showMsg("âŒ Open this from Telegram.","error");
  if (!gName)      return showMsg("âŒ Please enter a group name.","error");

  showMsg("â³ Creatingâ€¦","loading");
  document.getElementById("createBtn").disabled = true;

  try {
    const res = await fetch("/api/groups/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        telegramId,
        ownerName:    userName,
        name:         gName,
        description:  document.getElementById("gDesc").value.trim(),
        isPrivate:    document.getElementById("isPrivate").checked,
        isPremiumOnly:document.getElementById("isPremiumOnly").checked,
        avatar:       buildAvatarValue()   // â† tiny JSON, not base64
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed");
    showMsg("âœ… Group created!","success");
    setTimeout(() => location.href = "group.html?id=" + data.groupId, 1000);
  } catch(err) {
    showMsg("âŒ " + err.message,"error");
    document.getElementById("createBtn").disabled = false;
  }
}

function showMsg(text, type) {
  document.getElementById("msgBox").innerHTML = `<div class="msg ${type}">${text}</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
buildEmojiGrid();
buildColorStrip();
renderPreview();
</script>
</body>
</html>
