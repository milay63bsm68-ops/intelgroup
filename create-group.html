<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Group</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{--bg:#17212b;--surface:#1e2c3a;--surface2:#242f3d;--accent:#5288c1;--accent2:#64b5f6;--text:#e8e8e8;--subtext:#8a9ba8;--border:#2b3a4a;--green:#4db6ac;}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;}
.header{background:var(--surface);padding:14px 16px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;}
.back-btn{background:none;border:none;color:var(--accent2);font-size:22px;cursor:pointer;}
.header-title{font-size:17px;font-weight:700;}
.form{padding:20px 16px;max-width:480px;margin:0 auto;}
.sec-label{font-size:11px;color:var(--subtext);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;margin-top:20px;}
.av-center{display:flex;justify-content:center;margin-bottom:20px;}
.av-pick{width:80px;height:80px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:32px;color:white;cursor:pointer;position:relative;overflow:hidden;border:3px solid var(--border);}
.av-pick img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.av-edit{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.55);font-size:12px;text-align:center;padding:4px;color:white;}
.av-pick input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.inp{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:13px 14px;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.inp:focus{border-color:var(--accent2);}
textarea.inp{resize:none;height:90px;font-family:inherit;}
.char-count{text-align:right;font-size:11px;color:var(--subtext);margin-top:4px;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:8px;}
.toggle-info{flex:1;margin-right:12px;}
.toggle-label{font-size:14px;font-weight:600;}
.toggle-sub{font-size:12px;color:var(--subtext);margin-top:2px;}
.sw{position:relative;width:44px;height:24px;flex-shrink:0;}
.sw input{opacity:0;width:0;height:0;position:absolute;}
.sw-track{position:absolute;inset:0;border-radius:12px;background:#2b3a4a;cursor:pointer;transition:background 0.2s;}
.sw input:checked~.sw-track{background:var(--accent);}
.sw-thumb{position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:50%;background:white;transition:transform 0.2s;pointer-events:none;}
.sw input:checked~.sw-track .sw-thumb{transform:translateX(20px);}
.btn-create{width:100%;padding:15px;margin-top:24px;border:none;border-radius:14px;background:var(--accent);color:white;font-size:16px;font-weight:700;cursor:pointer;}
.btn-create:active{transform:scale(0.98);}
.btn-create:disabled{opacity:0.4;}
.msg{padding:12px 14px;border-radius:12px;font-size:13px;margin-top:12px;}
.error{background:#3d1515;border:1px solid #ef5350;color:#fca5a5;}
.success{background:#1a3a2a;border:1px solid var(--green);color:#86efac;}
.loading{background:#2a2a15;border:1px solid #f59e0b;color:#fcd34d;}
</style>
</head>
<body>
<div class="header">
  <button class="back-btn" onclick="history.back()">‚Üê</button>
  <div class="header-title">New Group</div>
</div>
<div class="form">
  <div class="av-center">
    <div class="av-pick" id="avPick">
      <span id="avLetter">G</span>
      <div class="av-edit">üì∑</div>
      <input type="file" accept="image/*" onchange="handleAv(this)">
    </div>
  </div>
  <div class="sec-label">Group Name *</div>
  <input class="inp" id="gName" maxlength="64" placeholder="Enter group name‚Ä¶" oninput="updateLetter();document.getElementById('nc').textContent=this.value.length">
  <div class="char-count"><span id="nc">0</span>/64</div>
  <div class="sec-label">Description</div>
  <textarea class="inp" id="gDesc" maxlength="255" placeholder="What is this group about?" oninput="document.getElementById('dc').textContent=this.value.length"></textarea>
  <div class="char-count"><span id="dc">0</span>/255</div>
  <div class="sec-label">Settings</div>
  <div class="toggle-row">
    <div class="toggle-info"><div class="toggle-label">üîí Private Group</div><div class="toggle-sub">Only people with the link can join</div></div>
    <label class="sw"><input type="checkbox" id="isPrivate"><div class="sw-track"><div class="sw-thumb"></div></div></label>
  </div>
  <div class="toggle-row">
    <div class="toggle-info"><div class="toggle-label">‚≠ê Premium Only</div><div class="toggle-sub">Only premium users can join</div></div>
    <label class="sw"><input type="checkbox" id="isPremiumOnly"><div class="sw-track"><div class="sw-thumb"></div></div></label>
  </div>
  <button class="btn-create" id="createBtn" onclick="createGroup()">‚úÖ Create Group</button>
  <div id="msgBox"></div>
</div>
<script>
const tg = window.Telegram?.WebApp;
tg?.ready();
const user = tg?.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;
const name = user?.first_name || "Guest";
let avatarBase64 = null;

function updateLetter() {
  const v = document.getElementById("gName").value;
  if (!avatarBase64) document.getElementById("avLetter").textContent = v.charAt(0).toUpperCase() || "G";
}
function handleAv(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    avatarBase64 = e.target.result;
    document.getElementById("avPick").innerHTML = `<img src="${avatarBase64}" alt=""><div class="av-edit">üì∑</div><input type="file" accept="image/*" onchange="handleAv(this)">`;
  };
  reader.readAsDataURL(file);
}
async function createGroup() {
  const gName = document.getElementById("gName").value.trim();
  if (!telegramId) return showMsg("‚ùå Open this from Telegram.","error");
  if (!gName) return showMsg("‚ùå Please enter a group name.","error");
  showMsg("‚è≥ Creating‚Ä¶","loading");
  document.getElementById("createBtn").disabled = true;
  try {
    const res = await fetch("/api/groups/create", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        telegramId, ownerName: name,
        name: gName,
        description: document.getElementById("gDesc").value.trim(),
        isPrivate: document.getElementById("isPrivate").checked,
        isPremiumOnly: document.getElementById("isPremiumOnly").checked,
        avatar: avatarBase64 || null
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed");
    showMsg("‚úÖ Group created!","success");
    setTimeout(() => location.href = "group.html?id=" + data.groupId, 1000);
  } catch(err) {
    showMsg("‚ùå " + err.message,"error");
    document.getElementById("createBtn").disabled = false;
  }
}
function showMsg(text,type){ document.getElementById("msgBox").innerHTML = `<div class="msg ${type}">${text}</div>`; }
</script>
</body>
</html>
