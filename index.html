<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Groups</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#17212b;--surface:#1e2c3a;--surface2:#242f3d;
  --accent:#5288c1;--accent2:#64b5f6;
  --text:#e8e8e8;--subtext:#8a9ba8;--border:#2b3a4a;
  --green:#4db6ac;--gold:#ffd700;
}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;}
.header{position:sticky;top:0;z-index:100;background:var(--surface);padding:10px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}

/* ‚îÄ‚îÄ Balance widget (left side of header) ‚îÄ‚îÄ */
.bal-widget{display:flex;flex-direction:column;align-items:flex-start;cursor:pointer;flex-shrink:0;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:6px 10px;min-width:90px;transition:border-color 0.2s;}
.bal-widget:hover{border-color:var(--accent);}
.bal-widget:active{opacity:0.8;}
.bal-ngn{font-size:13px;font-weight:700;color:var(--green);line-height:1.2;}
.bal-usd{font-size:10px;color:var(--subtext);line-height:1.2;}
.bal-hint{font-size:9px;color:var(--accent2);margin-top:2px;}

.search-wrap{flex:1;position:relative;}
.search-inp{background:var(--surface2);border:none;border-radius:20px;padding:8px 36px 8px 14px;color:var(--text);font-size:14px;width:100%;outline:none;}
.search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--subtext);}
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);}
.tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:600;color:var(--subtext);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
.tab.active{color:var(--accent2);border-color:var(--accent2);}
.user-card{background:var(--surface2);margin:12px 16px;border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px;border:1px solid var(--border);}
.u-avatar{width:44px;height:44px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:white;flex-shrink:0;}
.u-name{font-size:15px;font-weight:700;}
.u-sub{font-size:12px;color:var(--subtext);}
.premium-tag{margin-left:auto;background:linear-gradient(135deg,#f59e0b,#f97316);color:white;font-size:11px;font-weight:700;padding:3px 9px;border-radius:10px;flex-shrink:0;}
.free-tag{margin-left:auto;background:var(--surface);color:var(--subtext);font-size:11px;padding:3px 9px;border-radius:10px;flex-shrink:0;cursor:pointer;border:1px solid var(--border);}
.group-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;}
.group-item:hover,.group-item:active{background:var(--surface2);}
.g-avatar{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:white;flex-shrink:0;position:relative;overflow:hidden;}
.g-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.my-badge{position:absolute;bottom:-2px;right:-2px;background:var(--gold);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;border:2px solid var(--bg);}
.g-info{flex:1;min-width:0;}
.g-name-row{display:flex;align-items:center;gap:6px;margin-bottom:2px;}
.g-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.g-time{font-size:11px;color:var(--subtext);flex-shrink:0;}
.g-preview{font-size:13px;color:var(--subtext);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.g-members{font-size:11px;color:var(--subtext);}
.vip-badge{background:linear-gradient(135deg,#f59e0b,#f97316);color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;flex-shrink:0;}
.fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:26px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(82,136,193,0.5);cursor:pointer;z-index:200;transition:transform 0.15s;}
.fab:active{transform:scale(0.93);}
/* Pulse ring around FAB to draw attention */
.fab.pulse::after{content:'';position:absolute;inset:-6px;border-radius:50%;border:2px solid var(--accent2);opacity:0;animation:fabPulse 1.4s ease-out infinite;}
@keyframes fabPulse{0%{transform:scale(0.85);opacity:0.8}100%{transform:scale(1.5);opacity:0;}}
.fab-label{
  position:fixed;bottom:32px;right:86px;
  background:var(--accent);color:white;
  font-size:13px;font-weight:700;
  padding:8px 16px;border-radius:24px;
  white-space:nowrap;z-index:199;
  box-shadow:0 4px 14px rgba(82,136,193,0.5);
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
  opacity:0;transform:translateX(16px);
  transition:opacity 0.3s ease,transform 0.3s ease;
}
.fab-label.show{opacity:1;transform:translateX(0);}
.fab-label.hide{opacity:0;transform:translateX(16px);pointer-events:none;}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--subtext);text-align:center;}
.empty-icon{font-size:56px;margin-bottom:16px;opacity:0.5;}
.empty-title{font-size:16px;font-weight:600;margin-bottom:6px;color:var(--text);}
.empty-sub{font-size:13px;line-height:1.6;}
.skel-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);}
.skeleton{background:linear-gradient(90deg,var(--surface) 25%,var(--surface2) 50%,var(--surface) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:6px;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.skel-av{width:52px;height:52px;border-radius:50%;}
.skel-ln{height:12px;margin-bottom:6px;border-radius:4px;}

/* Balance action bottom-sheet */
.bal-sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:300;display:none;align-items:flex-end;justify-content:center;}
.bal-sheet-bg.open{display:flex;}
.bal-sheet{background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:24px 20px 32px;animation:slideup 0.25s ease;}
@keyframes slideup{from{transform:translateY(60px);opacity:0}to{transform:none;opacity:1}}
.bs-handle{width:40px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 18px;}
.bs-title{font-size:17px;font-weight:700;margin-bottom:4px;}
.bs-bal{font-size:28px;font-weight:800;color:var(--green);margin-bottom:2px;}
.bs-usd{font-size:13px;color:var(--subtext);margin-bottom:20px;}
.bs-btns{display:flex;gap:12px;}
.bs-btn{flex:1;padding:14px;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;color:white;}
.bs-btn:active{transform:scale(0.97);}
.bs-deposit{background:var(--green);}
.bs-withdraw{background:var(--accent);}
</style>
</head>
<body>
<div class="header">
  <!-- Balance widget ‚Äî left side -->
  <div class="bal-widget" id="balWidget" onclick="openBalSheet()">
    <div class="bal-ngn" id="hwBalNgn">‚Ç¶‚Äî</div>
    <div class="bal-usd" id="hwBalUsd">‚âà $‚Äî</div>
    <div class="bal-hint">üí∞ tap</div>
  </div>

  <div class="search-wrap">
    <input class="search-inp" id="searchInput" placeholder="Search groups‚Ä¶" oninput="renderGroups()">
    <span class="search-icon">üîç</span>
  </div>
</div>

<div class="user-card" id="userCard">
  <div class="u-avatar" id="uAv">?</div>
  <div><div class="u-name" id="uName">Loading‚Ä¶</div><div class="u-sub" id="uSub"></div></div>
  <div id="uTag"></div>
</div>

<div class="tabs">
  <div class="tab active" id="tabAll"    onclick="switchTab('all')">All Groups</div>
  <div class="tab"        id="tabMine"   onclick="switchTab('mine')">My Groups</div>
  <div class="tab"        id="tabJoined" onclick="switchTab('joined')">Joined</div>
</div>

<div id="groupList">
  <div class="skel-item"><div class="skeleton skel-av"></div><div style="flex:1"><div class="skeleton skel-ln" style="width:60%"></div><div class="skeleton skel-ln" style="width:80%"></div></div></div>
  <div class="skel-item"><div class="skeleton skel-av"></div><div style="flex:1"><div class="skeleton skel-ln" style="width:50%"></div><div class="skeleton skel-ln" style="width:70%"></div></div></div>
</div>

<button class="fab" id="fabBtn" onclick="location.href='create-group.html'" ontouchstart="">‚úèÔ∏è</button>
<div class="fab-label" id="fabLabel" onclick="location.href='create-group.html'" ontouchstart="">Create Group ‚úèÔ∏è</div>

<!-- Balance bottom sheet -->
<div class="bal-sheet-bg" id="balSheetBg" onclick="closeBalSheet()">
  <div class="bal-sheet" onclick="event.stopPropagation()">
    <div class="bs-handle"></div>
    <div class="bs-title">üí∞ Your Balance</div>
    <div class="bs-bal" id="bsBal">‚Ç¶‚Äî</div>
    <div class="bs-usd" id="bsUsd">‚âà $‚Äî</div>
    <div class="bs-btns">
      <button class="bs-btn bs-deposit"  onclick="closeBalSheet();location.href='deposit.html'">‚¨áÔ∏è Deposit</button>
      <button class="bs-btn bs-withdraw" onclick="closeBalSheet();openWithdraw()">‚¨ÜÔ∏è Withdraw</button>
    </div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.ready(); tg?.expand();
const user       = tg?.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;
const uName      = user?.first_name || "Guest";
const uUsername  = user?.username || "";
const NEW_RENDER = "";  // same server ‚Äî leave empty

/* ‚îÄ‚îÄ Deep link: if opened via share link (startapp=<groupId>), go straight to group ‚îÄ‚îÄ */
(function handleStartParam() {
  const urlParams = new URLSearchParams(location.search);
  const startParam = urlParams.get("tgWebAppStartParam")
    || tg?.initDataUnsafe?.start_param
    || urlParams.get("startapp")
    || null;
  if (startParam && /^[A-F0-9]{10}$/i.test(startParam)) {
    // Looks like a valid groupId ‚Äî redirect to that group
    location.href = "group.html?id=" + startParam;
  }
})();

document.getElementById("uAv").textContent   = uName.charAt(0).toUpperCase();
document.getElementById("uName").textContent  = uName + (uUsername ? " (@"+uUsername+")" : "");
document.getElementById("uSub").textContent   = "ID: " + (telegramId || "N/A");

let allGroups    = {};
let premiumUsers = [];
let isPremium    = false;
let currentTab   = "all";
let joinedGroups = JSON.parse(localStorage.getItem("joinedGroups") || "[]");
let userBalNgn   = 0;
let userUsdRate  = 1600;

/* ‚îÄ‚îÄ Load balance for header widget ‚îÄ‚îÄ */
async function loadBalance() {
  if (!telegramId) return;
  try {
    const res  = await fetch("/get-balance", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ telegramId })
    });
    const data = await res.json();
    userBalNgn  = data?.ngn     || 0;
    userUsdRate = data?.usdRate || 1600;
    const ngnStr = "‚Ç¶" + userBalNgn.toLocaleString();
    const usdStr = "‚âà $" + (userBalNgn / userUsdRate).toFixed(2);
    document.getElementById("hwBalNgn").textContent = ngnStr;
    document.getElementById("hwBalUsd").textContent  = usdStr;
    document.getElementById("bsBal").textContent     = ngnStr;
    document.getElementById("bsUsd").textContent     = usdStr;
  } catch(e) {
    document.getElementById("hwBalNgn").textContent = "‚Ç¶‚Äî";
  }
}

function openBalSheet()  { document.getElementById("balSheetBg").classList.add("open"); }
function closeBalSheet() { document.getElementById("balSheetBg").classList.remove("open"); }

function openWithdraw() {
  // Withdrawal is handled by the bot mini-app link
  window.open("https://t.me/intelpremiumbot/withdraw", "_blank");
}

async function loadAll() {
  try {
    const [gRes, pRes] = await Promise.all([
      fetch("/api/groups"),
      fetch("/api/premium-list")
    ]);
    allGroups    = await gRes.json();
    premiumUsers = await pRes.json();
    isPremium    = telegramId && premiumUsers.includes(telegramId);
    const tag = document.getElementById("uTag");
    tag.innerHTML = isPremium
      ? '<div class="premium-tag">‚≠ê Premium</div>'
      : '<div class="free-tag" onclick="location.href=\'premium.html\'">Upgrade ‚≠ê</div>';
    renderGroups();
  } catch(e) {
    document.getElementById("groupList").innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Failed to load</div></div>';
  }
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.getElementById("tab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add("active");
  renderGroups();
}

function avatarColor(name) {
  const colors = ["#5288c1","#4db6ac","#7986cb","#e57373","#81c784","#ff8a65","#9575cd","#4fc3f7"];
  let h = 0;
  for (let i = 0; i < name.length; i++) h = (h + name.charCodeAt(i)) % colors.length;
  return colors[h];
}

function renderGroups() {
  const q    = document.getElementById("searchInput").value.toLowerCase();
  const list = document.getElementById("groupList");
  let groups = Object.entries(allGroups);
  if (currentTab === "mine")   groups = groups.filter(([id,g]) => g.ownerId === telegramId);
  if (currentTab === "joined") groups = groups.filter(([id])   => joinedGroups.includes(id));
  if (q) groups = groups.filter(([id,g]) => g.name.toLowerCase().includes(q) || (g.description||"").toLowerCase().includes(q));
  if (groups.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">${currentTab==="mine"?"üõ†Ô∏è":currentTab==="joined"?"üöÄ":"üí¨"}</div><div class="empty-title">${currentTab==="mine"?"No groups yet":currentTab==="joined"?"No joined groups":"No groups found"}</div><div class="empty-sub">${currentTab==="mine"?"Tap ‚úèÔ∏è to create your first group":"Join a group from All Groups"}</div></div>`;
    return;
  }
  groups.sort((a,b) => (b[1].lastMessageAt||0) - (a[1].lastMessageAt||0));
  list.innerHTML = groups.map(([id,g]) => {
    const isOwner  = g.ownerId === telegramId;
    const isJoined = joinedGroups.includes(id);
    const color    = avatarBgColor(g.avatar, g.name);
    const av       = renderGroupAvatarHtml(g.avatar, g.name, color);
    const mc       = Object.keys(g.members||{}).length;
    const last     = g.lastMessage || "No messages yet";
    const timeStr  = g.lastMessageAt ? formatTime(g.lastMessageAt) : "";
    return `<div class="group-item" onclick="location.href='group.html?id=${id}'">
      <div class="g-avatar" style="background:${color}">${av}${isOwner?'<div class="my-badge">‚≠ê</div>':""}</div>
      <div class="g-info">
        <div class="g-name-row"><div class="g-name">${esc(g.name||"Unnamed")}</div>${timeStr?`<div class="g-time">${timeStr}</div>`:""}</div>
        <div class="g-preview">${esc(last)}</div>
        <div class="g-members">üë• ${mc} member${mc!==1?"s":""}${isOwner?" ¬∑ <b style='color:var(--gold)'>Your group</b>":""}${isJoined&&!isOwner?" ¬∑ Joined":""}</div>
      </div>
      ${g.isPremiumOnly?'<div class="vip-badge">VIP</div>':""}
    </div>`;
  }).join("");
}

function formatTime(ts) {
  const d = new Date(ts), now = new Date();
  if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
  return d.toLocaleDateString([],{month:"short",day:"numeric"});
}
function esc(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* ‚îÄ‚îÄ Avatar renderer ‚Äî handles emoji JSON, plain URL, base64, fallback ‚îÄ‚îÄ */
function renderGroupAvatarHtml(avatar, name, color) {
  if (!avatar) {
    return `<span>${(name||"G").charAt(0).toUpperCase()}</span>`;
  }
  if (avatar.startsWith("data:image/")) {
    return `<img src="${avatar}" alt="">`;
  }
  if (avatar.startsWith("{")) {
    try {
      const av = JSON.parse(avatar);
      if (av.type === "emoji") {
        return `<span style="font-size:24px">${av.emoji}</span>`;
      }
      if (av.type === "url") {
        return `<img src="${esc(av.src)}" alt="" onerror="this.parentElement.innerHTML='<span>G</span>'">`;
      }
    } catch(e) {}
  }
  if (avatar.startsWith("http")) {
    return `<img src="${esc(avatar)}" alt="" onerror="this.parentElement.innerHTML='<span>G</span>'">`;
  }
  return `<span>${(name||"G").charAt(0).toUpperCase()}</span>`;
}

/* ‚îÄ‚îÄ Avatar background color ‚Äî only used when no image/emoji ‚îÄ‚îÄ */
function avatarBgColor(avatar, name) {
  if (avatar && (avatar.startsWith("http") || avatar.startsWith("data:") || avatar.startsWith("{"))) {
    // For URL/image: use transparent bg; for emoji JSON: extract color
    if (avatar.startsWith("{")) {
      try { const av = JSON.parse(avatar); if (av.color) return av.color; } catch(e) {}
    }
    return "transparent";
  }
  return avatarColor(name);
}

// Load balance and groups in parallel
loadBalance();
loadAll();

/* ‚îÄ‚îÄ FAB label: show "Create Group ‚úèÔ∏è" on load, pulse FAB, re-show every 30s ‚îÄ‚îÄ */
(function() {
  const label = document.getElementById("fabLabel");
  const fab   = document.getElementById("fabBtn");

  function showLabel() {
    label.classList.remove("hide");
    label.classList.add("show");
    fab.classList.add("pulse");
    setTimeout(() => {
      label.classList.add("hide");
      fab.classList.remove("pulse");
      setTimeout(() => label.classList.remove("show","hide"), 350);
    }, 3000);
  }

  // Show on load after a short delay
  setTimeout(showLabel, 800);

  // Re-show every 30s to nudge users who haven't created a group yet
  setInterval(showLabel, 30000);
})();
</script>
</body>
</html>