<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Get Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{--bg:#17212b;--surface:#1e2c3a;--surface2:#242f3d;--accent:#5288c1;--text:#e8e8e8;--subtext:#8a9ba8;--border:#2b3a4a;--green:#4db6ac;--red:#ef5350;--gold:#ffd700;}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;min-height:100vh;}
.header{background:var(--surface);padding:14px 16px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;}
.back-btn{background:none;border:none;color:#64b5f6;font-size:22px;cursor:pointer;}
.header-title{font-size:17px;font-weight:700;}
.content{padding:20px 16px;max-width:460px;margin:0 auto;}
.hero{background:linear-gradient(135deg,#1a2a40,#2b3a55);border-radius:20px;padding:28px 20px;text-align:center;margin-bottom:20px;border:1px solid #2b5278;}
.hero-icon{font-size:52px;margin-bottom:10px;}
.hero-title{font-size:22px;font-weight:800;margin-bottom:6px;color:var(--gold);}
.hero-sub{font-size:14px;color:var(--subtext);line-height:1.6;}
.price-tag{display:inline-block;background:linear-gradient(135deg,#f59e0b,#f97316);color:white;font-size:24px;font-weight:800;padding:8px 24px;border-radius:50px;margin:14px 0;}
.bal-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.bal-label{font-size:12px;color:var(--subtext);}
.bal-val{font-size:20px;font-weight:700;color:var(--green);}
.bal-usd{font-size:12px;color:var(--subtext);}
.feats{margin-bottom:20px;}
.feat-title{font-size:13px;font-weight:700;color:var(--subtext);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;}
.feat{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface2);border-radius:12px;margin-bottom:8px;border:1px solid var(--border);font-size:14px;}
.feat-icon{font-size:20px;flex-shrink:0;}
.steps-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;}
.steps-title{font-size:14px;font-weight:700;margin-bottom:12px;}
.step{display:flex;gap:12px;margin-bottom:10px;align-items:flex-start;}
.step-num{width:26px;height:26px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;color:white;}
.step-txt{font-size:13px;color:var(--subtext);line-height:1.5;padding-top:4px;}
.pc-section{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;display:none;}
.pc-section.show{display:block;}
.inp{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-size:20px;outline:none;margin-top:8px;text-align:center;letter-spacing:6px;font-weight:700;}
.inp:focus{border-color:var(--accent);}
.btn{width:100%;padding:15px;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;color:white;margin-bottom:10px;}
.btn:active{transform:scale(0.98);}
.btn:disabled{opacity:0.4;cursor:not-allowed;}
.btn-gold{background:linear-gradient(135deg,#f59e0b,#f97316);}
.btn-blue{background:var(--accent);}
.btn-green{background:var(--green);}
.btn-gray{background:var(--surface2);color:var(--subtext);border:1px solid var(--border);}
.msg{padding:12px 14px;border-radius:12px;font-size:13px;margin-bottom:10px;line-height:1.5;}
.error{background:#3d1515;border:1px solid var(--red);color:#fca5a5;}
.success{background:#1a3a2a;border:1px solid var(--green);color:#86efac;}
.loading{background:#2a2a15;border:1px solid #f59e0b;color:#fcd34d;}
.info{background:#1a2a40;border:1px solid var(--accent);color:#93c5fd;}
.already-box{text-align:center;padding:40px 20px;}
.already-icon{font-size:60px;margin-bottom:16px;}
.already-title{font-size:20px;font-weight:700;color:var(--gold);margin-bottom:8px;}
.already-sub{font-size:14px;color:var(--subtext);line-height:1.6;}
</style>
</head>
<body>
<div class="header">
  <button class="back-btn" onclick="history.back()">‚Üê</button>
  <div class="header-title">‚≠ê Get Premium</div>
</div>
<div class="content" id="mainContent">
  <div class="hero">
    <div class="hero-icon">‚≠ê</div>
    <div class="hero-title">Go Premium</div>
    <div class="hero-sub">Unlimited messaging, exclusive groups & more</div>
    <div class="price-tag" id="priceTag">‚Ç¶5,000</div>
    <div id="priceUsd" style="font-size:13px;color:var(--subtext);margin-top:4px;">‚âà $‚Äî</div>
    <div style="font-size:12px;color:var(--subtext);margin-top:4px;">One-time payment ‚Ä¢ Permanent access</div>
  </div>
  <div class="bal-card">
    <div>
      <div class="bal-label">Your Balance</div>
      <div class="bal-val" id="balVal">‚Ç¶‚Äî</div>
      <div class="bal-usd" id="balUsd">‚âà $‚Äî</div>
    </div>
    <div style="font-size:28px">üí∞</div>
  </div>
  <div id="msgBox"></div>
  <div class="feats">
    <div class="feat-title">What you get</div>
    <div class="feat"><span class="feat-icon">üí¨</span>Unlimited messages ‚Äî no rate limits</div>
    <div class="feat"><span class="feat-icon">‚ö°</span>Send as fast as you like in all groups</div>
    <div class="feat"><span class="feat-icon">üîì</span>Access premium-only exclusive groups</div>
    <div class="feat"><span class="feat-icon">üé§</span>Unlimited voice notes</div>
    <div class="feat"><span class="feat-icon">üåü</span>Premium badge on your profile</div>
  </div>
  <div class="steps-card">
    <div class="steps-title">How it works</div>
    <div class="step"><div class="step-num">1</div><div class="step-txt">Click Get Premium ‚Äî ‚Ç¶5,000 will be deducted from your balance</div></div>
    <div class="step"><div class="step-num">2</div><div class="step-txt">A 6-digit code is sent to <a href="https://t.me/intelpremiumbot" target="_blank" style="color:#64b5f6;font-weight:700;">@intelpremiumbot</a> ‚Äî tap to open it</div></div>
    <div class="step"><div class="step-num">3</div><div class="step-txt">Enter the code here ‚Äî you are instantly upgraded!</div></div>
  </div>
  <button class="btn btn-gold" id="getCodeBtn" onclick="requestCode()">‚≠ê Get Premium ‚Äî ‚Ç¶5,000</button>
  <button class="btn btn-gray" id="depositBtn" onclick="location.href='deposit.html'" style="display:none">üí∞ Deposit Funds First</button>
  <div class="pc-section" id="pcSection">
    <div class="msg info" style="line-height:2;">
      ‚úÖ Verification code sent to your Telegram bot.<br>
      <a href="https://t.me/intelpremiumbot" target="_blank"
         style="color:#64b5f6;font-weight:700;font-size:14px;">
        üëâ Open @intelpremiumbot to get your code
      </a>
    </div>
    <input class="inp" id="pcInput" type="number" placeholder="000000" maxlength="6">
    <button class="btn btn-green" style="margin-top:12px" onclick="confirmPremium()">‚úÖ Confirm Purchase</button>
  </div>
</div>
<script>
const tg = window.Telegram?.WebApp;
tg?.ready(); tg?.expand();
const user       = tg?.initDataUnsafe?.user;
const telegramId = user ? String(user.id) : null;
const name       = user?.first_name || "Guest";
const username   = user?.username ? "@"+user.username : "";
const params     = new URLSearchParams(location.search);
const groupId    = params.get("groupId") || null;
const COST       = 5000;
let balance      = 0;
let usdRate      = 1600;

async function init() {
  if (!telegramId) {
    showMsg("‚ùå Please open this from Telegram.","error");
    document.getElementById("getCodeBtn").disabled = true;
    return;
  }
  try {
    // Check if already premium
    const pRes  = await fetch("/api/premium-list");
    const pList = await pRes.json();
    if (pList.includes(telegramId)) {
      document.getElementById("mainContent").innerHTML = `
        <div class="already-box">
          <div class="already-icon">‚≠ê</div>
          <div class="already-title">You're already Premium!</div>
          <div class="already-sub">You have full access to all premium features.<br>Go enjoy unlimited messaging!</div>
          <br><button class="btn btn-blue" onclick="history.back()">‚Üê Go Back</button>
        </div>`;
      return;
    }
    // Load balance (proxy ‚Üí balance server)
    const bRes  = await fetch("/get-balance", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ telegramId })
    });
    const bData = await bRes.json();
    balance  = bData?.ngn     || 0;
    usdRate  = bData?.usdRate || 1600;

    // Show balance
    document.getElementById("balVal").textContent = "‚Ç¶" + balance.toLocaleString();
    document.getElementById("balUsd").textContent = "‚âà $" + (balance / usdRate).toFixed(2);

    // Show live USD price of premium
    const costUsd = (COST / usdRate).toFixed(2);
    document.getElementById("priceUsd").textContent = "‚âà $" + costUsd;
    document.getElementById("getCodeBtn").textContent =
      `‚≠ê Get Premium ‚Äî ‚Ç¶${COST.toLocaleString()} ($${costUsd})`;

    if (balance < COST) {
      const short = COST - balance;
      showMsg(
        `‚ö†Ô∏è You need ‚Ç¶${COST.toLocaleString()} ($${costUsd}) but have ‚Ç¶${balance.toLocaleString()}. ` +
        `Deposit ‚Ç¶${short.toLocaleString()} more.`,
        "error"
      );
      document.getElementById("getCodeBtn").style.display = "none";
      document.getElementById("depositBtn").style.display = "block";
    }
  } catch(e) {
    showMsg("‚ùå Failed to load balance","error");
  }
}

async function requestCode() {
  if (!telegramId) return;
  if (balance < COST) return location.href = "deposit.html";
  showMsg("‚è≥ Sending verification code to your Telegram‚Ä¶","loading");
  document.getElementById("getCodeBtn").disabled = true;
  try {
    // Passcode is generated and stored on the balance server
    const res  = await fetch("/generate-premium-passcode", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ telegramId })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed");
    showMsg("","");
    document.getElementById("pcSection").classList.add("show");
    document.getElementById("getCodeBtn").style.display = "none";
  } catch(err) {
    showMsg("‚ùå " + err.message,"error");
    document.getElementById("getCodeBtn").disabled = false;
  }
}

async function confirmPremium() {
  const code = document.getElementById("pcInput").value.trim();
  if (!code || code.length < 6) return showMsg("‚ùå Enter the 6-digit code from Telegram.","error");
  showMsg("‚è≥ Verifying and processing payment‚Ä¶","loading");
  document.querySelector(".btn-green").disabled = true;
  try {
    const res  = await fetch("/api/buy-premium", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ telegramId, name, username, passcode: code, groupId })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Purchase failed");
    const newUsd = (data.newBalance / usdRate).toFixed(2);
    showMsg(
      `üéâ ${data.message}<br>` +
      `üí∞ Paid: ‚Ç¶${COST.toLocaleString()} ($${data.premiumCostUsd || (COST/usdRate).toFixed(2)})<br>` +
      `üí≥ New balance: ‚Ç¶${data.newBalance.toLocaleString()} ($${data.buyerUsd || newUsd})`,
      "success"
    );
    document.getElementById("balVal").textContent = "‚Ç¶" + data.newBalance.toLocaleString();
    document.getElementById("balUsd").textContent = "‚âà $" + (data.buyerUsd || newUsd);
    document.querySelector(".btn-green").disabled = true;
  } catch(err) {
    showMsg("‚ùå " + err.message,"error");
    document.querySelector(".btn-green").disabled = false;
  }
}

function showMsg(text, type) {
  document.getElementById("msgBox").innerHTML = text ? `<div class="msg ${type}">${text}</div>` : "";
}
init();
</script>
</body>
</html>